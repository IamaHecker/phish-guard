{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Email Templates</h1>
    <a href="{{ url_for('admin.create_template') }}" class="btn btn-primary">Create Template</a>
</div>

<div class="card">
    <div class="card-body">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Subject</th>
                    <th>Landing Page</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for template in templates %}
                <tr>
                    <td>{{ template.name }}</td>
                    <td>{{ template.subject }}</td>
                    <td>{{ template.landing_page_id }}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                            data-bs-target="#previewModal"
                            data-url="{{ url_for('admin.preview_template', id=template.id) }}">
                            Preview
                        </button>
                        <a href="{{ url_for('admin.edit_template', id=template.id) }}"
                            class="btn btn-sm btn-secondary">Edit</a>
                        <form action="{{ url_for('admin.delete_template', id=template.id) }}" method="post"
                            class="d-inline"
                            onsubmit="return confirm('Are you sure you want to delete this template?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="background-color: #fff; color: #333;">
            <!-- Force light theme for email preview container context -->
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel" style="color: #333;">Template Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="previewFrame" src="" style="width: 100%; height: 500px; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var previewModal = document.getElementById('previewModal');
        previewModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var url = button.getAttribute('data-url');
            var modalBodyInput = previewModal.querySelector('#previewFrame');
            modalBodyInput.src = url;
        });

        // Clear src on close to stop audio/video if any
        previewModal.addEventListener('hidden.bs.modal', function (event) {
            var modalBodyInput = previewModal.querySelector('#previewFrame');
            modalBodyInput.src = '';
        });
    });
</script>
{% endblock %}